apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  name: kiali
spec:
  destination:
    name: in-cluster
    namespace: istio-system
  project: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
      - ServerSideApply=true
  source:
    repoURL: https://kiali.org/helm-charts
    chart: kiali-server
    targetRevision: 2.7.1
    helm:
      valuesObject:
        auth:
          strategy: openid
          openid:
            client_id: kiali
            issuer_uri: https://dex.horus.khuedoan.com
            disable_rbac: true
        external_services:
          prometheus:
            url: http://monitoring-system-kube-pro-prometheus.monitoring-system:9090
          grafana:
            enabled: false
        deployment:
          view_only_mode: true
          ingress:
            enabled: true
            override_yaml:
              metadata:
                annotations:
                  cert-manager.io/cluster-issuer: letsencrypt-prod
              spec:
                ingressClassName: nginx
                rules:
                  - host: kiali.horus.khuedoan.com
                    http:
                      paths:
                      - backend:
                          service:
                            name: kiali
                            port:
                              name: http
                        path: /
                        pathType: Prefix
                tls:
                  - hosts:
                      - kiali.horus.khuedoan.com
                    secretName: kiali-tls-certificate
        server:
          web_fqdn: kiali.horus.khuedoan.com
          web_root: /
